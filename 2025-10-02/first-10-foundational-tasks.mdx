# First 10 Foundational & Parallelizable High-Impact Tasks

**Date:** 2025-10-02
**Purpose:** Initial sprint for microservices architecture migration
**Duration:** 2-3 weeks with parallel execution
**Max Parallelization:** 6 concurrent agents

---

## Execution Strategy

### Phase 1: Foundation + Infrastructure (Week 1)
**Parallel Execution Group A (Start Day 1)**

#### 1. WS-001: @db/ RPC Service ‚≠ê CRITICAL PATH
- **Priority:** P0 (blocks everything)
- **Duration:** 3-5 days
- **Agent:** Backend Engineer A
- **Parallelizable:** No (foundation)

**Deliverables:**
- `@db/src/index.ts` - DatabaseService with WorkerEntrypoint
- Query modules for all 14 tables (things, relationships, users, generations, etc.)
- Full-text, vector, and hybrid search functions
- Transaction support
- 80%+ test coverage

**Success Criteria:**
```typescript
‚úÖ All CRUD operations via RPC
‚úÖ db.getThing(ns, id) returns in <10ms (p95)
‚úÖ Full-text search working with PostgreSQL tsvector
‚úÖ Vector search with pgvector
‚úÖ Deployed to staging as `db-service`
```

---

#### 2. WS-004: Workers Scaffolding ‚ö° PARALLEL
- **Priority:** P1
- **Duration:** 2-3 days
- **Agent:** DevOps Engineer A
- **Parallelizable:** Yes (independent of WS-001)

**Deliverables:**
- Service template generator CLI
- Pre-configured templates (domain, integration, ai)
- Shared packages: `workers/types/`, `workers/utils/`
- Root monorepo configuration
- Documentation

**Success Criteria:**
```bash
‚úÖ pnpm create-service --name agents --type domain
‚úÖ Generated service has RPC + HTTP + MCP + Queue
‚úÖ Template includes tests, wrangler config, types
‚úÖ Can scaffold new service in <30 seconds
```

---

#### 3. WS-005: Testing Infrastructure ‚ö° PARALLEL
- **Priority:** P1
- **Duration:** 2-3 days
- **Agent:** QA Engineer A
- **Parallelizable:** Yes (independent of WS-001)

**Deliverables:**
- Vitest + @cloudflare/vitest-pool-workers setup
- Integration test framework (service-to-service RPC)
- E2E test framework (Playwright)
- Mock service factories
- Test data generators

**Success Criteria:**
```typescript
‚úÖ Unit tests run with `pnpm test`
‚úÖ Integration tests can mock RPC calls
‚úÖ E2E tests can test full flows
‚úÖ CI runs all tests on PR
‚úÖ Coverage reports generated
```

---

### Phase 2: Auth + Gateway (Week 1-2)
**Sequential After WS-001 Complete**

#### 4. WS-002: @auth/ RPC Service üîí DEPENDS ON DB
- **Priority:** P0
- **Duration:** 3-5 days
- **Agent:** Backend Engineer B (can be same as A)
- **Parallelizable:** After WS-001
- **Dependencies:** WS-001 (needs db for users, sessions, api_keys)

**Deliverables:**
- `@auth/src/index.ts` - AuthService with WorkerEntrypoint
- better-auth integration (GitHub OAuth)
- API key validation
- JWT generation and validation
- Session management

**Success Criteria:**
```typescript
‚úÖ auth.validateToken(token) returns User in <5ms
‚úÖ GitHub OAuth flow working
‚úÖ API key authentication working
‚úÖ JWT tokens include user claims
‚úÖ Deployed to staging as `auth-service`
```

---

#### 5. WS-006: CI/CD Setup ‚ö° PARALLEL TO AUTH
- **Priority:** P1
- **Duration:** 2-3 days
- **Agent:** DevOps Engineer A (continues from WS-004)
- **Parallelizable:** Yes (parallel to WS-002)
- **Dependencies:** WS-005 (needs testing infrastructure)

**Deliverables:**
- GitHub Actions workflows for each service
- Staging deployment pipeline
- Production deployment with canary (10% traffic)
- Auto-rollback on errors
- Monitoring and alerting (Sentry, LogFlare)

**Success Criteria:**
```yaml
‚úÖ PR ‚Üí tests + deploy to staging automatically
‚úÖ Merge to main ‚Üí canary deploy to production
‚úÖ Failed deployment auto-rolls back
‚úÖ Alerts fire on 5xx errors or high latency
‚úÖ Dashboard shows all service health
```

---

#### 6. WS-003: @api/ Gateway üö™ DEPENDS ON DB + AUTH
- **Priority:** P0
- **Duration:** 3-5 days
- **Agent:** Backend Engineer C
- **Parallelizable:** After WS-001 & WS-002
- **Dependencies:** WS-001 (db), WS-002 (auth)

**Deliverables:**
- `@api/src/index.ts` - Pure routing gateway (NO business logic)
- Domain routing (agents.do, mcp.do, workflows.do)
- Path routing (/agents/*, /things/*)
- Middleware (auth, rate limiting, CORS)
- Service binding forwarding

**Success Criteria:**
```typescript
‚úÖ Routes /things/* to ThingsService via RPC
‚úÖ Domain agents.do ‚Üí AgentsService
‚úÖ Auth middleware validates JWT/API keys
‚úÖ Rate limiting via Durable Objects
‚úÖ Routing overhead <1ms (p95)
‚úÖ Deployed to staging as `api-gateway`
```

---

### Phase 3: Core Services (Week 2-3)
**Parallel Execution After WS-003 Complete**

All services depend on @db/ (WS-001) and @api/ (WS-003) being deployed.

#### 7. WS-101: things/ Service üì¶ PARALLEL
- **Duration:** 2-3 days
- **Agent:** Backend Engineer D
- **Extract from:** api.services/api/routes/things.ts (21.7KB)

**Deliverables:**
- `workers/things/src/index.ts` - ThingsService
- RPC: getThing, createThing, updateThing, deleteThing, listThings
- HTTP: REST API endpoints
- MCP: tools for LLMs
- Queue: async operations
- Tests: 80%+ coverage

**Success Criteria:**
```typescript
‚úÖ things.getThing('agent', 'my-agent') via RPC
‚úÖ GET /things/:id returns JSON/MDX
‚úÖ MCP tool get_thing() works
‚úÖ Gateway routes /things/* correctly
‚úÖ All 50+ tests passing
```

---

#### 8. WS-102: relationships/ Service üîó PARALLEL
- **Duration:** 2-3 days
- **Agent:** Backend Engineer E
- **Extract from:** api.services/api/routes/relationships.ts (3.0KB)

**Deliverables:**
- `workers/relationships/src/index.ts` - RelationshipsService
- RPC: getRelationships, createRelationship, deleteRelationship
- HTTP: REST API endpoints
- MCP: tools for relationship queries
- Tests: 80%+ coverage

**Success Criteria:**
```typescript
‚úÖ relationships.getRelationships('agent', 'my-agent')
‚úÖ POST /relationships creates new relationship
‚úÖ MCP tool create_relationship() works
‚úÖ Gateway routes /relationships/* correctly
```

---

#### 9. WS-103: search/ Service üîç PARALLEL
- **Duration:** 2-3 days
- **Agent:** Backend Engineer F
- **Extract from:** api.services/api/routes/search.ts (5.0KB)

**Deliverables:**
- `workers/search/src/index.ts` - SearchService
- RPC: fullTextSearch, vectorSearch, hybridSearch
- HTTP: GET /search?q=query
- MCP: semantic search tools
- Advanced ranking algorithms
- Tests: 80%+ coverage

**Success Criteria:**
```typescript
‚úÖ search.fullTextSearch('agent tools') returns ranked results
‚úÖ search.vectorSearch(embedding, { limit: 10 })
‚úÖ search.hybridSearch(query, embedding) combines both
‚úÖ Results include relevance scores
‚úÖ Query latency <50ms (p95)
```

---

#### 10. WS-106: ai/ Service ü§ñ PARALLEL
- **Duration:** 2-3 days
- **Agent:** AI Engineer A
- **Extract from:** api.services/api/routes/ai.ts (4.7KB)

**Deliverables:**
- `workers/ai/src/index.ts` - AIService
- RPC: generateText, generateStream, analyzeContent
- HTTP: POST /ai/generate
- MCP: AI generation tools
- Support for multiple providers (OpenAI, Workers AI, Anthropic)
- Tests: 80%+ coverage

**Success Criteria:**
```typescript
‚úÖ ai.generateText(prompt, { model: 'gpt-4' })
‚úÖ ai.generateStream() returns ReadableStream
‚úÖ POST /ai/generate works
‚úÖ MCP tool generate_text() callable
‚úÖ Provider fallback working
‚úÖ Generation latency <2s (p95)
```

---

## Parallelization Timeline

```
Week 1:
Day 1-5:  [WS-001 db]‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
Day 1-3:  [WS-004 scaffolding]‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
Day 1-3:  [WS-005 testing]‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§       ‚îÇ
                                         ‚ñº       ‚ñº
Day 3-8:                            [WS-002 auth]‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
Day 3-6:                            [WS-006 CI/CD]‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
                                                          ‚ñº   ‚ñº
Day 6-11:                                            [WS-003 gateway]
                                                          ‚îÇ
Week 2-3:                                                 ‚ñº
Day 12-15: [WS-101 things]‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
Day 12-15: [WS-102 relationships]‚îÄ‚îÄ‚îÄ‚î§                    ‚îÇ
Day 12-15: [WS-103 search]‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                    ‚îÇ
Day 12-15: [WS-106 ai]‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ
                                                          ‚ñº
Week 3:                                              [Next 6 services...]
```

**Total Duration:** 15-20 days
**Max Concurrent Agents:** 6
**Critical Path:** WS-001 ‚Üí WS-002 ‚Üí WS-003 (11-15 days)

---

## Agent Role Assignment

| Agent | Role | Tasks | Duration |
|-------|------|-------|----------|
| **Backend Engineer A** | Database & Foundation | WS-001 (db) ‚Üí WS-002 (auth) | Week 1-2 |
| **DevOps Engineer A** | Infrastructure | WS-004 (scaffolding) ‚Üí WS-006 (CI/CD) | Week 1-2 |
| **QA Engineer A** | Testing | WS-005 (testing) ‚Üí continuous | Week 1+ |
| **Backend Engineer B** | Gateway | WS-003 (gateway) | Week 2 |
| **Backend Engineer C** | Core Services | WS-101 (things) | Week 2-3 |
| **Backend Engineer D** | Core Services | WS-102 (relationships) | Week 2-3 |
| **Backend Engineer E** | Core Services | WS-103 (search) | Week 2-3 |
| **AI Engineer A** | AI Services | WS-106 (ai) | Week 2-3 |

---

## Success Metrics

### After 10 Tasks Complete:

**Infrastructure:**
- ‚úÖ 3 foundational services deployed (db, auth, gateway)
- ‚úÖ Service template generator working
- ‚úÖ Testing framework operational
- ‚úÖ CI/CD pipelines running

**Services:**
- ‚úÖ 4 core services extracted and deployed
- ‚úÖ Gateway routing all 4 services
- ‚úÖ All services <100ms latency (p95)
- ‚úÖ 80%+ test coverage across all services

**Migration Progress:**
- ‚úÖ ~20% of api.services routes extracted (4/49)
- ‚úÖ Database fully isolated into @db/
- ‚úÖ Auth fully isolated into @auth/
- ‚úÖ Gateway pattern proven and working

---

## Next Steps After Task 10

**Week 3-4: Continue Core Services (WS-104 through WS-110)**
- WS-104: queue/ service
- WS-105: events/ service
- WS-107: embeddings/ service
- WS-108: batch/ service
- WS-109: code-exec/ service
- WS-110: claude-code/ service

**Week 5-6: Integration Services (WS-201 through WS-210)**
- External API integrations (VAPI, Stripe, WorkOS, GitHub, Slack)
- Content services (docs, markdown, SDK)

**Week 7-8: Domain Services (WS-301 through WS-315)**
- High-level features (agents, workflows, marketplace, billing)

---

## Risk Mitigation

### Critical Path Risks:
1. **WS-001 Delays** ‚Üí Blocks everything
   - Mitigation: Start immediately, assign best backend engineer
   - Fallback: Parallel work on WS-004, WS-005 continues

2. **RPC Performance** ‚Üí May not meet <10ms target
   - Mitigation: Early performance testing in WS-001
   - Fallback: Optimize or add caching layer

3. **Service Binding Limits** ‚Üí Cloudflare has limits per worker
   - Mitigation: Gateway can fan out to multiple sub-gateways
   - Fallback: Domain-based routing reduces bindings per worker

### Technical Risks:
1. **better-auth in Workers** ‚Üí May have compatibility issues
   - Mitigation: Research and POC in WS-002
   - Fallback: Custom JWT implementation

2. **MCP Server in Workers** ‚Üí New, may be unstable
   - Mitigation: Use official @modelcontextprotocol/sdk
   - Fallback: REST-only initially, add MCP later

3. **Vitest Pool Workers** ‚Üí Experimental
   - Mitigation: WS-005 validates early
   - Fallback: Use Miniflare for testing

---

## Resource Requirements

### Human Resources:
- 6-8 engineers (4 backend, 1 AI, 1 DevOps, 1 QA, 1 tech writer)

### Infrastructure:
- Cloudflare Workers Paid plan ($5/month base + usage)
- Neon PostgreSQL (scale tier, ~$50/month)
- GitHub Actions (included with org)
- Sentry (free tier or $26/month team)

### Timeline:
- **Week 1-2:** Foundation (6 tasks)
- **Week 2-3:** Core services (4 tasks)
- **Total:** 15-20 days for first 10 tasks

---

**Status:** Ready to assign to agents
**Next Action:** Create detailed implementation specs for each task
**Owner:** Architecture Team
