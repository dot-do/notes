# CI/CD Security Blocker & Workers for Platforms Migration

**Date:** 2025-10-03
**Status:** 🔴 BLOCKED - Security Concern
**Priority:** P0 - Critical Architecture Decision

## The Problem

### Current Approach (Insecure)
We were setting up GitHub Actions CI/CD with:
- `CLOUDFLARE_ACCOUNT_ID` stored in GitHub secrets ✅ Set
- `CLOUDFLARE_API_TOKEN` stored in GitHub secrets ❌ **SECURITY RISK**

### Why This is a Problem

**Credential Exposure Risks:**
1. **GitHub secrets are accessible to all workflows** - Any compromised workflow can access the token
2. **Third-party action risks** - Actions we don't control could exfiltrate secrets
3. **Supply chain attacks** - Compromised dependencies could steal credentials
4. **Overly broad permissions** - Single token has account-wide access
5. **Audit trail gaps** - Hard to track which deployment used which credentials
6. **Rotation complexity** - Rotating tokens requires updating GitHub secrets

**Blast Radius:**
- Full account access to all Workers, KV, D1, R2, Queues
- Ability to deploy arbitrary code to production
- Access to environment variables and secrets
- Potential data exfiltration or service disruption

## The Solution: Workers for Platforms

### What is Workers for Platforms?

**Workers for Platforms** is Cloudflare's multi-tenant Workers solution that enables:
- **Zero Cloudflare credentials in CI/CD** - No API tokens needed
- **API-controlled deployments** - Your API authenticates deployments
- **Namespace isolation** - Each tenant/environment in separate namespace
- **Custom authentication** - Use your own auth (API keys, JWTs, OAuth)
- **Fine-grained RBAC** - Control who can deploy what, where

### Architecture Comparison

#### Current (Insecure)
```
┌──────────────┐
│ GitHub       │
│ Actions      │─────┐
└──────────────┘     │
                     │ Cloudflare API Token
                     │ (stored in secrets)
                     ▼
              ┌──────────────┐
              │ Cloudflare   │
              │ API          │
              │              │
              │ ┌──────────┐ │
              │ │ Workers  │ │
              │ └──────────┘ │
              └──────────────┘
```

#### Workers for Platforms (Secure)
```
┌──────────────┐
│ GitHub       │
│ Actions      │─────┐
└──────────────┘     │
                     │ API Key (your auth)
                     ▼
              ┌──────────────┐
              │ Your Deploy  │
              │ API Service  │◄─── You control auth
              └──────┬───────┘
                     │ Workers for Platforms API
                     │ (scoped to dispatch namespace)
                     ▼
              ┌──────────────┐
              │ Cloudflare   │
              │ Platform     │
              │              │
              │ ┌──────────┐ │
              │ │Namespace │ │
              │ │ Workers  │ │
              │ └──────────┘ │
              └──────────────┘
```

### Security Benefits

1. **Zero Cloudflare Credentials in CI/CD**
   - GitHub never sees Cloudflare credentials
   - Your API handles all Cloudflare communication
   - API keys are scoped to your system

2. **Centralized Authentication**
   - Single auth point through your API
   - Leverage existing auth (WorkOS, API keys, etc.)
   - Full audit trail of deployments

3. **Fine-Grained Access Control**
   - Per-service deployment permissions
   - Environment-specific access (dev/staging/prod)
   - Team-based RBAC

4. **Namespace Isolation**
   - Each environment in separate namespace
   - Limited blast radius per namespace
   - Easy to isolate customer deployments

5. **Easy Credential Rotation**
   - Rotate API keys without touching GitHub
   - Cloudflare credentials managed in one place
   - No workflow updates needed

## Implementation Plan

### Phase 1: Setup Workers for Platforms (1-2 days)

**1.1 Create Dispatch Namespace**
```bash
# In Cloudflare dashboard
# Workers & Pages → Workers for Platforms → Create Namespace
# Name: "dotdo-production"
```

**1.2 Create Deploy API Service**
```typescript
// New service: workers/deploy/
// Handles authenticated deployments

export class DeployService extends WorkerEntrypoint<Env> {
  // Authenticate deployment request
  async deploy(params: {
    service: string
    script: string
    bindings: Record<string, any>
    metadata: Record<string, any>
  }) {
    // 1. Verify API key (via AUTH_SERVICE)
    // 2. Check RBAC permissions (can user deploy this service?)
    // 3. Deploy to dispatch namespace via Cloudflare API
    // 4. Log deployment event
    // 5. Return deployment info
  }
}
```

**1.3 Update GitHub Actions**
```yaml
# .github/workflows/deploy.yml
- name: Deploy to Cloudflare
  run: |
    # Call YOUR API, not Cloudflare's
    curl -X POST https://api.do/.deploy \
      -H "Authorization: Bearer ${{ secrets.DEPLOY_API_KEY }}" \
      -H "Content-Type: application/json" \
      -d '{
        "service": "gateway",
        "script": "dist/index.js",
        "environment": "production"
      }'
```

### Phase 2: Migrate Services (1 week)

**Migration Order:**
1. ✅ Create deploy API service
2. ✅ Setup dispatch namespace
3. ✅ Test deployment flow with gateway service
4. ⏳ Migrate remaining 7 services
5. ⏳ Update all wrangler.jsonc configs
6. ⏳ Update CI/CD workflows
7. ⏳ Test end-to-end deployment

### Phase 3: Enhanced Security (Ongoing)

**3.1 Deployment Approval Workflow**
- Require approval for production deployments
- Automated staging deployments
- Integration test gates

**3.2 Audit Logging**
- Log all deployment requests
- Track who deployed what, when
- Deployment success/failure metrics

**3.3 Rollback Automation**
- Automatic rollback on health check failure
- Keep N previous versions
- One-click rollback via API

## Cost Implications

### Workers for Platforms Pricing
- **Standard Workers pricing** - $5/month per 10M requests
- **No additional platform fees** for dispatch namespaces
- **Same limits** as regular Workers

**Verdict:** No additional cost, better security

## Technical Details

### Dispatch Namespace Features

**Isolation:**
- Each namespace is isolated
- Separate KV, D1, R2, Queue bindings
- Independent deployment lifecycle

**Dynamic Dispatch:**
```typescript
// Your API can route to namespaces dynamically
const namespace = env.PRODUCTION_NAMESPACE // or DEV_NAMESPACE
const worker = namespace.get('gateway')
return await worker.fetch(request)
```

**User Workers:**
- Deploy "user workers" (tenant-specific code)
- Isolate customer deployments
- Multi-tenant SaaS platform

### Deployment API Design

**Endpoint:** `POST /api/deploy`

**Authentication:**
- API key validation via AUTH_SERVICE
- JWT token validation
- OAuth 2.0 support

**Request:**
```json
{
  "service": "gateway",
  "environment": "production",
  "script": "base64-encoded-bundle",
  "bindings": {
    "DB_SERVICE": "db",
    "AUTH_SERVICE": "auth"
  },
  "metadata": {
    "commit": "abc123",
    "branch": "main",
    "author": "user@example.com"
  }
}
```

**Response:**
```json
{
  "success": true,
  "deployment": {
    "id": "deploy_123",
    "service": "gateway",
    "environment": "production",
    "status": "deployed",
    "url": "https://gateway.do/",
    "version": "v1.2.3",
    "timestamp": "2025-10-03T01:30:00Z"
  }
}
```

### RBAC Permissions

**Permission Model:**
```typescript
interface DeploymentPermission {
  user: string
  service: string | '*'
  environment: 'dev' | 'staging' | 'production' | '*'
  actions: ('deploy' | 'rollback' | 'view')[]
}
```

**Examples:**
```typescript
// Developer can deploy to dev only
{ user: 'dev@do', service: '*', environment: 'dev', actions: ['deploy', 'rollback', 'view'] }

// CI/CD can deploy gateway to staging
{ user: 'ci-bot', service: 'gateway', environment: 'staging', actions: ['deploy'] }

// Admin can deploy anything anywhere
{ user: 'admin@do', service: '*', environment: '*', actions: ['deploy', 'rollback', 'view'] }
```

## Migration Checklist

### Pre-Migration
- [ ] Create Workers for Platforms dispatch namespace
- [ ] Test namespace isolation and routing
- [ ] Create deploy API service skeleton
- [ ] Define RBAC permission model
- [ ] Document deployment API spec

### Core Infrastructure
- [ ] Implement deployment API authentication
- [ ] Add RBAC permission checking
- [ ] Implement Cloudflare API integration
- [ ] Add deployment logging and audit trail
- [ ] Create rollback functionality

### Testing
- [ ] Test deploy API with mock deployments
- [ ] Validate RBAC enforcement
- [ ] Test namespace isolation
- [ ] Verify rollback functionality
- [ ] Load test deployment throughput

### Service Migration (for each of 8 services)
- [ ] Update wrangler.jsonc for dispatch namespace
- [ ] Test local deployment via deploy API
- [ ] Update GitHub Actions workflow
- [ ] Deploy to staging and test
- [ ] Deploy to production
- [ ] Monitor for issues
- [ ] Document migration

### Post-Migration
- [ ] Remove CLOUDFLARE_API_TOKEN from GitHub
- [ ] Verify all deployments working
- [ ] Setup deployment monitoring
- [ ] Create deployment runbook
- [ ] Train team on new deployment flow

## Next Steps

### Immediate (Today)
1. **Research Workers for Platforms** - Deep dive into documentation
2. **Design Deploy API** - Spec out the deployment service
3. **Create Dispatch Namespace** - Setup in Cloudflare dashboard
4. **Prototype Deploy API** - Basic implementation

### Short-term (This Week)
1. **Implement Deploy API** - Full RBAC, logging, rollback
2. **Migrate Gateway Service** - First service as proof-of-concept
3. **Update CI/CD Workflows** - Call deploy API instead of wrangler
4. **Test End-to-End** - Verify complete deployment flow

### Medium-term (Next 2 Weeks)
1. **Migrate All Services** - All 8 core services to Workers for Platforms
2. **Setup Monitoring** - Deployment metrics and alerts
3. **Document Processes** - Runbooks and troubleshooting guides
4. **Train Team** - New deployment workflows

## Resources

### Cloudflare Documentation
- [Workers for Platforms Overview](https://developers.cloudflare.com/cloudflare-for-platforms/workers-for-platforms/)
- [Dispatch Namespaces](https://developers.cloudflare.com/cloudflare-for-platforms/workers-for-platforms/platform/namespaces/)
- [Dynamic Dispatch](https://developers.cloudflare.com/cloudflare-for-platforms/workers-for-platforms/platform/dynamic-dispatch/)
- [User Workers](https://developers.cloudflare.com/cloudflare-for-platforms/workers-for-platforms/platform/user-workers/)

### API References
- [Workers for Platforms API](https://developers.cloudflare.com/api/operations/worker-script-(dispatch-namespace)-list-workers)
- [Script Upload](https://developers.cloudflare.com/api/operations/worker-script-(dispatch-namespace)-upload-worker-module)
- [Script Settings](https://developers.cloudflare.com/api/operations/worker-script-(dispatch-namespace)-get-settings)

## Conclusion

**Workers for Platforms solves our security concerns by:**
1. ✅ Removing Cloudflare credentials from CI/CD
2. ✅ Centralizing authentication through our API
3. ✅ Enabling fine-grained access control
4. ✅ Providing namespace isolation
5. ✅ Improving audit trails and observability

**Trade-offs:**
- ⚠️ Additional deploy API service to maintain
- ⚠️ Migration effort (1-2 weeks)
- ⚠️ New deployment workflow to learn

**Verdict:** ✅ **Proceed with Workers for Platforms migration**

The security benefits far outweigh the implementation effort. This is the right architecture for a production multi-tenant platform.

---

**Status:** Blocked - Awaiting decision to proceed with Workers for Platforms
**Next Step:** Research Workers for Platforms documentation and create detailed implementation plan
**Estimated Effort:** 1-2 weeks for complete migration
**Risk Level:** Low - Cloudflare managed service, well-documented
